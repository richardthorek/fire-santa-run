name: CI/CD Pipeline

# This workflow runs quality checks and deploys the Fire Santa Run application to Azure Static Web Apps
#
# Workflow Structure:
# 1. Quality Checks Job (lint, test, coverage) - runs first, fails fast
# 2. Deploy Job (builds and deploys to Azure) - only runs if quality checks pass
# 3. Close PR Job (closes preview environments) - runs when PR is closed
# 4. Failure Issue Job (creates GitHub issue) - runs if deployment fails on main branch
#
# Build Process:
# - Frontend: Built by Azure Static Web Apps' Oryx (Vite + React + TypeScript)
# - API: Built by Oryx using api_build_command (Azure Functions v4 + Node.js + TypeScript)
#   The api_build_command runs "npm install && npm run build" which compiles TypeScript to JavaScript
# 
# This workflow uses the "copilot" environment for secrets.
# 
# Required GitHub Secrets (in the "copilot" environment):
#   - VITE_MAPBOX_TOKEN: Mapbox API token for maps and geocoding (required for build)
#   - AZURE_STATIC_WEB_APPS_API_TOKEN_VICTORIOUS_BEACH_0D2B6DC00: Deployment token (auto-generated by Azure)
#
# Optional GitHub Secrets (for production features):
#   - VITE_AZURE_STORAGE_CONNECTION_STRING: Azure Table Storage connection string
#   - AZURE_WEBPUBSUB_CONNECTION_STRING: Azure Web PubSub connection string
#
# Note: Dependabot PRs will skip deployment as they cannot access environment secrets

on:
  push:
    branches:
      - main
  pull_request:
    types: [opened, synchronize, reopened, closed]
    branches:
      - main

jobs:
  quality_checks:
    # Run quality checks first - skip if PR is being closed
    if: github.event_name == 'push' || (github.event_name == 'pull_request' && github.event.action != 'closed')
    runs-on: ubuntu-latest
    name: Quality Checks (Lint, Test, Coverage)
    permissions:
      contents: read
      pull-requests: write
    steps:
      - name: Checkout code
        uses: actions/checkout@v6
        
      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: '22.x'
          cache: 'npm'
          
      - name: Install dependencies
        run: npm ci
        
      - name: Run linter
        run: npm run lint
        
      - name: Run tests with coverage
        run: npm run test:coverage
        env:
          # Required for tests that may reference these
          VITE_DEV_MODE: 'true'
          VITE_MAPBOX_TOKEN: 'test-token'
          
      - name: Comment coverage on PR
        if: github.event_name == 'pull_request'
        uses: romeovs/lcov-reporter-action@v0.3.1
        with:
          lcov-file: ./coverage/lcov.info
          github-token: ${{ secrets.GITHUB_TOKEN }}
          delete-old-comments: true

  build_and_deploy_job:
    # Deploy only after quality checks pass
    needs: quality_checks
    # Skip deployment for Dependabot PRs as they cannot access environment secrets
    if: |
      github.actor != 'dependabot[bot]' &&
      (github.event_name == 'push' || (github.event_name == 'pull_request' && github.event.action != 'closed'))
    runs-on: ubuntu-latest
    name: Build and Deploy Job
    environment: copilot
    permissions:
      contents: read
      pull-requests: write
    steps:
      - uses: actions/checkout@v6
        with:
          submodules: true
          lfs: false
      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: '22.x'
      - name: Install dependencies
        run: npm ci
      - name: Build And Deploy
        id: builddeploy
        uses: Azure/static-web-apps-deploy@v1
        env:
          # Vite environment variables must be prefixed with VITE_ and set at build time
          VITE_DEV_MODE: 'false'
          VITE_MAPBOX_TOKEN: ${{ secrets.VITE_MAPBOX_TOKEN }}
          VITE_APP_NAME: 'Fire Santa Run'
          # Entra External ID configuration (required for production builds)
          VITE_ENTRA_CLIENT_ID: ${{ secrets.VITE_ENTRA_CLIENT_ID }}
          VITE_ENTRA_TENANT_ID: ${{ secrets.VITE_ENTRA_TENANT_ID }}
          VITE_ENTRA_AUTHORITY: ${{ secrets.VITE_ENTRA_AUTHORITY }}
          VITE_ENTRA_REDIRECT_URI: ${{ secrets.VITE_ENTRA_REDIRECT_URI }}
        with:
          azure_static_web_apps_api_token: ${{ secrets.AZURE_STATIC_WEB_APPS_API_TOKEN_VICTORIOUS_BEACH_0D2B6DC00 }}
          repo_token: ${{ secrets.GITHUB_TOKEN }} # Used for Github integrations (i.e. PR comments)
          action: "upload"
          skip_deploy_on_missing_secrets: true # Skip deployment if secrets are not available (e.g., in forks)
          ###### Repository/Build Configurations - These values can be configured to match your app requirements. ######
          # For more information regarding Static Web App workflow configurations, please visit: https://aka.ms/swaworkflowconfig
          app_location: "/" # App source code path
          api_location: "api" # Api source code path - optional
          api_build_command: "npm install && npm run build" # Build command for API
          output_location: "dist" # Built app content directory - optional
          ###### End of Repository/Build Configurations ######

  smoke_tests:
    # Run smoke tests after successful deployment
    needs: build_and_deploy_job
    if: |
      github.actor != 'dependabot[bot]' &&
      (github.event_name == 'push' || (github.event_name == 'pull_request' && github.event.action != 'closed'))
    runs-on: ubuntu-latest
    name: Smoke Tests
    permissions:
      contents: read
      pull-requests: write
    steps:
      - name: Checkout code
        uses: actions/checkout@v6
        
      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: '22.x'
          cache: 'npm'
      
      - name: Install dependencies
        run: npm ci
      
      - name: Wait for deployment
        run: sleep 30
        
      - name: Run smoke tests on staging environment
        id: smoke_tests
        run: |
          if [ "${{ github.event_name }}" == "pull_request" ]; then
            # For PRs, test the preview environment
            DEPLOYMENT_URL="https://victorious-beach-0d2b6dc00-${{ github.event.pull_request.number }}.azurestaticapps.net"
          else
            # For pushes to main, test production
            DEPLOYMENT_URL="https://victorious-beach-0d2b6dc00.azurestaticapps.net"
          fi
          
          echo "Testing deployment at: $DEPLOYMENT_URL"
          node scripts/smoke-test.js "$DEPLOYMENT_URL" || true
        continue-on-error: true
      
      - name: Comment smoke test results on PR
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v8
        with:
          script: |
            const fs = require('fs');
            const body = `## üß™ Smoke Test Results
            
            Smoke tests have been executed on the preview deployment.
            
            **Deployment URL:** https://victorious-beach-0d2b6dc00-${{ github.event.pull_request.number }}.azurestaticapps.net
            
            ‚ÑπÔ∏è Check the workflow logs for detailed results.
            
            Note: Some tests may fail if secrets are not available in preview environments.`;
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: body
            });

  close_pull_request_job:
    # This job runs independently when a PR is closed (doesn't need quality checks)
    if: github.event_name == 'pull_request' && github.event.action == 'closed'
    runs-on: ubuntu-latest
    name: Close Pull Request Job
    permissions:
      contents: read
      pull-requests: write
    steps:
      - name: Close Pull Request
        id: closepullrequest
        uses: Azure/static-web-apps-deploy@v1
        with:
          azure_static_web_apps_api_token: ${{ secrets.AZURE_STATIC_WEB_APPS_API_TOKEN_VICTORIOUS_BEACH_0D2B6DC00 }}
          action: "close"

  create_bug_issue_on_failure:
    # Create issue if quality checks or deployment fail on push to main
    if: ${{ failure() && github.event_name == 'push' }}
    runs-on: ubuntu-latest
    needs: [quality_checks, build_and_deploy_job, smoke_tests]
    name: Create Bug Issue on Failure
    permissions:
      issues: write
      actions: read
    steps:
      - name: Create Bug Issue
        uses: actions/github-script@v8
        with:
          script: |
            const runId = context.runId;
            const repo = context.repo;
            const sha = context.sha;
            const workflow = context.workflow;
            const runUrl = `https://github.com/${repo.owner}/${repo.repo}/actions/runs/${runId}`;
            
            // Fetch workflow run details
            const workflowRun = await github.rest.actions.getWorkflowRun({
              owner: repo.owner,
              repo: repo.repo,
              run_id: runId
            });
            
            // Fetch jobs for this workflow run
            const jobs = await github.rest.actions.listJobsForWorkflowRun({
              owner: repo.owner,
              repo: repo.repo,
              run_id: runId
            });
            
            // Find failed jobs
            const failedJobs = jobs.data.jobs.filter(job => job.conclusion === 'failure');
            
            // Build issue body
            let issueBody = `## üî• Workflow Failure Report\n\n`;
            issueBody += `**Workflow:** ${workflow}\n`;
            issueBody += `**Run:** [#${workflowRun.data.run_number}](${runUrl})\n`;
            issueBody += `**Commit:** [\`${sha.substring(0, 7)}\`](https://github.com/${repo.owner}/${repo.repo}/commit/${sha})\n`;
            issueBody += `**Branch:** ${workflowRun.data.head_branch}\n`;
            issueBody += `**Triggered by:** @${workflowRun.data.triggering_actor.login}\n`;
            issueBody += `**Runner:** ${workflowRun.data.run_attempt > 1 ? `ubuntu-latest (attempt ${workflowRun.data.run_attempt})` : 'ubuntu-latest'}\n`;
            issueBody += `**Event:** ${context.eventName}\n\n`;
            
            // Add failed jobs information
            issueBody += `### Failed Jobs\n\n`;
            for (const job of failedJobs) {
              issueBody += `#### ${job.name}\n`;
              issueBody += `- **Status:** ${job.conclusion}\n`;
              issueBody += `- **Started:** ${job.started_at}\n`;
              issueBody += `- **Completed:** ${job.completed_at}\n`;
              issueBody += `- **Job URL:** ${job.html_url}\n`;
              
              // Find failed steps
              const failedSteps = job.steps.filter(step => step.conclusion === 'failure');
              if (failedSteps.length > 0) {
                issueBody += `- **Failed Steps:**\n`;
                for (const step of failedSteps) {
                  issueBody += `  - ${step.name} (step ${step.number})\n`;
                }
              }
              issueBody += `\n`;
            }
            
            // Add logs information
            issueBody += `### üìã Logs\n\n`;
            issueBody += `[View full workflow logs](${runUrl})\n\n`;
            
            for (const job of failedJobs) {
              issueBody += `**${job.name} logs:** [View logs](${job.html_url})\n\n`;
            }
            
            // Add commit information
            issueBody += `### üìù Commit Details\n\n`;
            issueBody += `**Message:** ${workflowRun.data.head_commit.message.split('\n')[0]}\n`;
            issueBody += `**Author:** ${workflowRun.data.head_commit.author.name}\n`;
            issueBody += `**Timestamp:** ${workflowRun.data.head_commit.timestamp}\n\n`;
            
            // Add troubleshooting section
            issueBody += `### üîç Next Steps\n\n`;
            issueBody += `1. Review the [workflow logs](${runUrl}) for detailed error messages\n`;
            issueBody += `2. Check the failed steps listed above\n`;
            issueBody += `3. Verify the commit changes didn't introduce breaking changes\n`;
            issueBody += `4. Re-run the workflow after fixing the issue\n\n`;
            
            issueBody += `---\n`;
            issueBody += `*This issue was automatically created by the workflow failure detection system.*`;
            
            // Create the issue
            const issue = await github.rest.issues.create({
              owner: repo.owner,
              repo: repo.repo,
              title: `üî• Workflow Failed: ${workflow} - Run #${workflowRun.data.run_number}`,
              body: issueBody,
              labels: ['bug']
            });
            
            console.log(`Created issue #${issue.data.number}: ${issue.data.html_url}`);
